<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project Moria - API Gateway</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #0a0a0a; color: #e0e0e0; }
    h1 { color: #f7931a; }
    h2 { color: #fff; margin-top: 30px; }
    .card { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 20px; margin: 15px 0; }
    input, button { padding: 10px 15px; border-radius: 5px; border: 1px solid #444; font-size: 14px; }
    input { background: #222; color: #fff; width: 100%; margin: 5px 0; }
    button { background: #f7931a; color: #000; cursor: pointer; font-weight: bold; border: none; margin: 5px 5px 5px 0; }
    button:hover { background: #ffa500; }
    button.secondary { background: #333; color: #fff; }
    pre { background: #111; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
    .success { color: #4caf50; }
    .error { color: #f44336; }
    .balance { font-size: 24px; color: #f7931a; }
    .hidden { display: none; }
    label { display: block; margin-top: 10px; color: #888; font-size: 12px; }
    .invoice-box { background: #222; padding: 15px; border-radius: 5px; word-break: break-all; font-family: monospace; font-size: 11px; }
    .qr { text-align: center; margin: 15px 0; }
    .session-key { font-family: monospace; font-size: 11px; word-break: break-all; background: #222; padding: 10px; border-radius: 5px; }
    .info-text { color: #888; font-size: 13px; margin-bottom: 15px; }
  </style>
</head>
<body>
  <h1>Project Moria</h1>
  <p>Lightning-powered API Gateway - No signup required, just pay and go!</p>

  <!-- API Status -->
  <div class="card">
    <h2>API Status</h2>
    <pre id="status">Loading...</pre>
  </div>

  <!-- Session Section -->
  <div class="card">
    <h2>Session</h2>
    <div id="session-create">
      <p class="info-text">No registration needed. Create a top-up, pay the Lightning invoice, and start using APIs immediately.</p>
      <label>Amount (sats) - minimum 100</label>
      <input type="number" id="topup-amount" value="1000" min="100">
      <button onclick="createTopup()">Create Top-up Invoice</button>
    </div>
    <div id="session-info" class="hidden">
      <p>Session Key:</p>
      <div class="session-key" id="session-key-display"></div>
      <p style="margin-top: 15px;">Balance: <span class="balance" id="session-balance">0</span> sats</p>
      <button onclick="refreshBalance()">Refresh Balance</button>
      <button class="secondary" onclick="logout()">Clear Session</button>
    </div>
    <div id="invoice-display" class="hidden">
      <p>Pay this Lightning invoice:</p>
      <div class="qr" id="qr-code"></div>
      <div class="invoice-box" id="invoice-string"></div>
      <button onclick="copyInvoice()">Copy Invoice</button>
      <button onclick="checkPayment()">Check Payment</button>
    </div>
    <pre id="session-result"></pre>
  </div>

  <!-- Gateway Test Section -->
  <div class="card">
    <h2>Test Gateway Proxy</h2>
    <label>Gateway ID</label>
    <input type="text" id="gateway-id" placeholder="kJQ1bBeaV-3R">
    <label>Path</label>
    <input type="text" id="gateway-path" value="/get">
    <button onclick="testGateway()">Make Request (costs sats!)</button>
    <pre id="gateway-result"></pre>
  </div>

  <!-- Developer Section -->
  <div class="card">
    <h2>Developer</h2>
    <div id="dev-login">
      <label>Email</label>
      <input type="email" id="dev-email" placeholder="dev@example.com">
      <label>Password</label>
      <input type="password" id="dev-password" placeholder="password">
      <button onclick="loginDeveloper()">Login</button>
      <button class="secondary" onclick="registerDeveloper()">Register</button>
    </div>
    <div id="dev-info" class="hidden">
      <p>Email: <strong id="dev-email-display"></strong></p>
      <p>Balance: <span class="balance" id="dev-balance">0</span> sats</p>
      <button onclick="getDeveloperProfile()">Refresh</button>
      <button class="secondary" onclick="logoutDeveloper()">Logout</button>
    </div>
    <pre id="dev-result"></pre>
  </div>

  <script>
    const API = '';  // Same origin
    let sessionKey = localStorage.getItem('sessionKey');
    let devToken = localStorage.getItem('devToken');
    let currentTopupId = null;

    // Initialize
    async function init() {
      await checkStatus();
      if (sessionKey) {
        await refreshBalance();
      }
      if (devToken) {
        await getDeveloperProfile();
      }
    }

    async function checkStatus() {
      try {
        const res = await fetch(API + '/api');
        const data = await res.json();
        document.getElementById('status').textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        document.getElementById('status').textContent = 'Error: ' + e.message;
      }
    }

    // Session functions
    async function createTopup() {
      const amount = parseInt(document.getElementById('topup-amount').value);
      try {
        const body = { amountSats: amount };
        // If we have an existing session, add funds to it
        if (sessionKey) {
          body.sessionKey = sessionKey;
        }

        const res = await fetch(API + '/api/sessions/topup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        document.getElementById('session-result').textContent = JSON.stringify(data, null, 2);

        if (data.sessionKey) {
          sessionKey = data.sessionKey;
          localStorage.setItem('sessionKey', sessionKey);
          currentTopupId = data.topupId;

          // Show session info and invoice
          document.getElementById('session-create').classList.add('hidden');
          document.getElementById('session-info').classList.remove('hidden');
          document.getElementById('session-key-display').textContent = sessionKey;
          document.getElementById('invoice-display').classList.remove('hidden');
          document.getElementById('invoice-string').textContent = data.paymentRequest;
          // Generate QR code
          document.getElementById('qr-code').innerHTML =
            `<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(data.paymentRequest)}" alt="Lightning Invoice QR">`;
        }
      } catch (e) {
        document.getElementById('session-result').textContent = 'Error: ' + e.message;
      }
    }

    async function refreshBalance() {
      if (!sessionKey) return;
      try {
        const res = await fetch(API + '/api/sessions/me', {
          headers: { 'X-Session-Key': sessionKey }
        });
        const data = await res.json();
        if (data.balanceSats !== undefined) {
          showSessionInfo(data);
        } else if (res.status === 401) {
          logout();
        }
      } catch (e) {
        console.error(e);
      }
    }

    function showSessionInfo(session) {
      document.getElementById('session-create').classList.add('hidden');
      document.getElementById('session-info').classList.remove('hidden');
      document.getElementById('session-key-display').textContent = sessionKey;
      document.getElementById('session-balance').textContent = session.balanceSats || 0;
    }

    function logout() {
      sessionKey = null;
      currentTopupId = null;
      localStorage.removeItem('sessionKey');
      document.getElementById('session-create').classList.remove('hidden');
      document.getElementById('session-info').classList.add('hidden');
      document.getElementById('invoice-display').classList.add('hidden');
      document.getElementById('session-result').textContent = '';
    }

    function copyInvoice() {
      const invoice = document.getElementById('invoice-string').textContent;
      navigator.clipboard.writeText(invoice);
      alert('Invoice copied!');
    }

    async function checkPayment() {
      if (!currentTopupId || !sessionKey) return;
      try {
        const res = await fetch(API + '/api/sessions/topup/' + currentTopupId, {
          headers: { 'X-Session-Key': sessionKey }
        });
        const data = await res.json();
        document.getElementById('session-result').textContent = JSON.stringify(data, null, 2);
        if (data.status === 'paid') {
          document.getElementById('invoice-display').classList.add('hidden');
          await refreshBalance();
          alert('Payment received! Balance updated.');
        }
      } catch (e) {
        document.getElementById('session-result').textContent = 'Error: ' + e.message;
      }
    }

    // Gateway test
    async function testGateway() {
      if (!sessionKey) {
        alert('Create a session first by topping up');
        return;
      }
      const gatewayId = document.getElementById('gateway-id').value;
      const path = document.getElementById('gateway-path').value;
      try {
        const res = await fetch(API + '/g/' + gatewayId + path, {
          headers: { 'X-Session-Key': sessionKey }
        });
        const balanceRemaining = res.headers.get('X-Balance-Remaining');
        const requestCost = res.headers.get('X-Request-Cost');
        const data = await res.json();
        let output = '';
        if (balanceRemaining) {
          output += `Cost: ${requestCost} sats | Balance: ${balanceRemaining} sats\n\n`;
        }
        output += JSON.stringify(data, null, 2);
        document.getElementById('gateway-result').textContent = output;
        await refreshBalance();
      } catch (e) {
        document.getElementById('gateway-result').textContent = 'Error: ' + e.message;
      }
    }

    // Developer functions
    async function registerDeveloper() {
      const email = document.getElementById('dev-email').value;
      const password = document.getElementById('dev-password').value;
      try {
        const res = await fetch(API + '/api/developers/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, name: email.split('@')[0] })
        });
        const data = await res.json();
        document.getElementById('dev-result').textContent = JSON.stringify(data, null, 2);
        if (data.token) {
          devToken = data.token;
          localStorage.setItem('devToken', devToken);
          showDevInfo(data);
        }
      } catch (e) {
        document.getElementById('dev-result').textContent = 'Error: ' + e.message;
      }
    }

    async function loginDeveloper() {
      const email = document.getElementById('dev-email').value;
      const password = document.getElementById('dev-password').value;
      try {
        const res = await fetch(API + '/api/developers/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        document.getElementById('dev-result').textContent = JSON.stringify(data, null, 2);
        if (data.token) {
          devToken = data.token;
          localStorage.setItem('devToken', devToken);
          await getDeveloperProfile();
        }
      } catch (e) {
        document.getElementById('dev-result').textContent = 'Error: ' + e.message;
      }
    }

    async function getDeveloperProfile() {
      if (!devToken) return;
      try {
        const res = await fetch(API + '/api/developers/me', {
          headers: { 'Authorization': 'Bearer ' + devToken }
        });
        const data = await res.json();
        if (data.email) {
          showDevInfo(data);
        } else if (res.status === 401) {
          logoutDeveloper();
        }
      } catch (e) {
        console.error(e);
      }
    }

    function showDevInfo(dev) {
      document.getElementById('dev-login').classList.add('hidden');
      document.getElementById('dev-info').classList.remove('hidden');
      document.getElementById('dev-email-display').textContent = dev.email;
      document.getElementById('dev-balance').textContent = dev.balanceSats || 0;
    }

    function logoutDeveloper() {
      devToken = null;
      localStorage.removeItem('devToken');
      document.getElementById('dev-login').classList.remove('hidden');
      document.getElementById('dev-info').classList.add('hidden');
      document.getElementById('dev-result').textContent = '';
    }

    init();
  </script>
</body>
</html>
